import aiohttp
import os
import time
from dotenv import load_dotenv
from datetime import datetime, timedelta
from aiohttp.client_exceptions import ClientError, ClientConnectionError, ClientPayloadError

# –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (.env)
load_dotenv()

# API-–∫–ª—é—á OpenWeather
WEATHER_API_KEY = os.getenv("WEATHER_API_KEY")
if not WEATHER_API_KEY:
    raise RuntimeError(
        "‚ùå –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è WEATHER_API_KEY –Ω–µ –∑–∞–¥–∞–Ω–∞. "
        "–°–æ–∑–¥–∞–π .env –∏ –¥–æ–±–∞–≤—å WEATHER_API_KEY='—Ç–≤–æ–π_–∫–ª—é—á'"
    )

BASE_URL = "https://api.openweathermap.org/data/2.5"

# –ö—ç—à
__cache = {}
CACHE_TTL = 600  # 10 –º–∏–Ω—É—Ç


# ---------- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ----------

def _get_from_cache(key: tuple):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∫—ç—à–∞ (–µ—Å–ª–∏ –Ω–µ –ø—Ä–æ—Ç—É—Ö)."""
    now = time.time()
    if key in __cache:
        ts, data = __cache[key]
        if now - ts < CACHE_TTL:
            return data
    return None


def _save_to_cache(key: tuple, data: dict):
    """–°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –∫—ç—à."""
    __cache[key] = (time.time(), data)


async def _fetch(endpoint: str, params: dict, cache_key: tuple) -> dict:
    """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ OpenWeather —Å –∫—ç—à–µ–º –∏ –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫."""
    cached = _get_from_cache(cache_key)
    if cached:
        return cached

    url = f"{BASE_URL}/{endpoint}"
    params["appid"] = WEATHER_API_KEY

    try:
        async with aiohttp.ClientSession() as session:
            async with session.get(url, params=params, timeout=10) as response:
                try:
                    data = await response.json()
                except Exception:
                    return {"cod": "500", "message": "–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ JSON –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞"}

                if response.status == 200:
                    _save_to_cache(cache_key, data)

                return data
    except (ClientError, ClientConnectionError, ClientPayloadError) as e:
        return {"cod": "500", "message": f"–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: {e}"}
    except Exception as e:
        return {"cod": "500", "message": f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞: {e}"}


# ---------- –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ----------

async def fetch_weather(city: str, units: str = "metric", lang: str = "ru") -> dict:
    """–ó–∞–ø—Ä–æ—Å —Ç–µ–∫—É—â–µ–π –ø–æ–≥–æ–¥—ã."""
    return await _fetch(
        "weather",
        {"q": city, "units": units, "lang": lang},
        (city.lower(), "weather")
    )


async def fetch_forecast(city: str, days: int = 3, units: str = "metric", lang: str = "ru") -> dict:
    """–ó–∞–ø—Ä–æ—Å –ø—Ä–æ–≥–Ω–æ–∑–∞ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π."""
    return await _fetch(
        "forecast",
        {"q": city, "units": units, "lang": lang, "cnt": days * 8},
        (city.lower(), f"forecast_{days}")
    )


async def fetch_nextday(city: str, units: str = "metric", lang: str = "ru") -> dict:
    """
    –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å —Å —à–∞–≥–æ–º 3 —á–∞—Å–∞ (6, 9, 12, 15, 18, 21, 24 —á–∞—Å–∞).
    """
    data = await _fetch(
        "forecast",
        {"q": city, "units": units, "lang": lang},
        (city.lower(), "nextday")
    )
    return data


# ---------- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ----------

def format_weather(data: dict) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –ø–æ–≥–æ–¥—ã."""
    if str(data.get("cod")) != "200":
        return f"‚ö†Ô∏è –û—à–∏–±–∫–∞: {data.get('message', '–Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ')}"

    city = data["name"]
    temp = round(data["main"]["temp"])
    feels_like = round(data["main"]["feels_like"])
    description = data["weather"][0]["description"].capitalize()

    return (
        f"üåç –ì–æ—Ä–æ–¥: {city}\n"
        f"üå° –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: {temp}¬∞C\n"
        f"ü§î –û—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫: {feels_like}¬∞C\n"
        f"‚òÅÔ∏è {description}"
    )


def format_forecast(data: dict) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≥–Ω–æ–∑–∞ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π."""
    if str(data.get("cod")) != "200":
        return f"‚ö†Ô∏è –û—à–∏–±–∫–∞: {data.get('message', '–Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ')}"

    city = data["city"]["name"]
    forecast_list = data["list"]

    # –ë–µ—Ä—ë–º –∫–∞–∂–¥—ã–µ 8 –∑–∞–ø–∏—Å–µ–π (~—Ä–∞–∑ –≤ —Å—É—Ç–∫–∏)
    days = forecast_list[::8]

    if not days:
        return f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ –¥–ª—è {city}"

    lines = [f"üìÖ –ü—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã: {city}"]
    for item in days:
        dt = datetime.fromtimestamp(item["dt"]).strftime("%d.%m %H:%M")
        temp = round(item["main"]["temp"])
        feels_like = round(item["main"]["feels_like"])
        description = item["weather"][0]["description"].capitalize()
        lines.append(
            f"\nüìç {dt}\n"
            f"üå° {temp}¬∞C (–æ—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫ {feels_like}¬∞C)\n"
            f"‚òÅÔ∏è {description}"
        )

    return "\n".join(lines)


def format_nextday(data: dict) -> str:
    """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–≥–Ω–æ–∑–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å —Å —à–∞–≥–æ–º 3 —á–∞—Å–∞."""
    if str(data.get("cod")) != "200":
        return f"‚ö†Ô∏è –û—à–∏–±–∫–∞: {data.get('message', '–Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ')}"

    city = data["city"]["name"]
    forecast_list = data["list"]

    if not forecast_list:
        return f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ –¥–ª—è {city}"

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ª–µ–¥—É—é—â–∏–µ 24 —á–∞—Å–∞ –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏
    now = datetime.now()
    next_day = now + timedelta(days=1)
    next_day_start = datetime(next_day.year, next_day.month, next_day.day)
    next_day_end = next_day_start + timedelta(hours=24)

    # –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –¥–∞–Ω–Ω—ã–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è
    items_next_day = [
        item for item in forecast_list
        if next_day_start <= datetime.fromtimestamp(item["dt"]) < next_day_end
    ]

    if not items_next_day:
        return f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è –≤ {city}"

    lines = [f"üìÖ –ü—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å: {city}"]
    for item in items_next_day:
        dt = datetime.fromtimestamp(item["dt"]).strftime("%H:%M")
        temp = round(item["main"]["temp"])
        feels_like = round(item["main"]["feels_like"])
        description = item["weather"][0]["description"].capitalize()
        lines.append(
            f"\nüìç {dt}\n"
            f"üå° {temp}¬∞C (–æ—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫ {feels_like}¬∞C)\n"
            f"‚òÅÔ∏è {description}"
        )

    return "\n".join(lines)